<!DOCTYPE html>
<html lang="es" style="
-ms-overflow-style: none;
 scrollbar-width: none; 
 ">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="icon" href="/images/PahadiLogo.png" type="image/png" style="height: 512px;width: 512px;">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/css/bootstrap.min.css">

    <style>
        .container-div {
            margin-top: 107px !important;
            margin-bottom: 1rem;
        }

        .form-control:focus {
            box-shadow: none;
            border-color: #BA68C8
        }

        .profile-button {
            background: rgb(99, 39, 120);
            box-shadow: none;
            border: none
        }

        .profile-button:hover {
            background: #682773
        }

        .profile-button:focus {
            background: #682773;
            box-shadow: none
        }

        .profile-button:active {
            background: #682773;
            box-shadow: none
        }

        .back:hover {
            color: #682773;
            cursor: pointer
        }

        .labels {
            font-size: 11px
        }

        .add-experience:hover {
            background: #BA68C8;
            color: #fff;
            cursor: pointer;
            border: solid 1px #BA68C8
        }

        .form-control {
            border: 1px solid black !important;
        }

        @media (min-width:767px) and (max-width:991px) {
            .container-div {
                margin-top: 212px !important;

            }
        }

        @media (max-width:767px) {
            .container-div {
                margin-top: 60px !important;
                margin-bottom: 80px;
                overflow-x: hidden;

            }
        }
    </style>
</head>

<body>
    <%- include("header.ejs") %>
        <div class="container-div rounded bg-white ">
            <div class="row">
                <div class="col-md-3 border-right">
                    <div class="d-flex flex-column align-items-center text-center p-3 py-5"><img
                            class="rounded-circle mt-5" width="150px"
                            src="https://st3.depositphotos.com/15648834/17930/v/600/depositphotos_179308454-stock-illustration-unknown-person-silhouette-glasses-profile.jpg">
                    </div>
                </div>
                <div class="col-md-9 border-right">
                    <div class="p-3 py-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="text-right">Profile Settings</h4>
                        </div>
                        <div class="container">
                            <div class="row">
                                <div
                                    class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xs-offset-0 col-sm-offset-0 col-md-offset-3 col-lg-offset-3 toppad">
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">
                                            <h3 class="panel-title user_name"></h3>
                                        </div>
                                        <div class="panel-body">
                                            <div class="row">

                                                <div class=" col-md-9 col-lg-9 ">
                                                    <table class="table table-user-information">
                                                        <tbody>
                                                            <tr>
                                                                <td>Email</td>
                                                                <td class="user_email">
                                                                </td>
                                                            </tr>
                                                            <td>Contact</td>
                                                            <td class="user_contact">
                                                            </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    <button onclick="updateProfile()">Update</button>
                                                    <button onclick="logout()">Logout</button>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="user-form-container" style="display: none;">
                            <button class="btn btn-primary" onclick="logout()">Logout</button>
                            <button class="btn btn-primary" onclick="window.location.reload()">Back</button>

                            <form id="user-form">

                                <div class="row mt-2">
                                    <div class="col-md-12"><label class="labels">Address</label><textarea
                                            class="form-control" placeholder="enter address" name="customer_address"
                                            value="" required></textarea></div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6"><label class="labels">Name</label><input type="text"
                                            class="form-control" placeholder="first name" name="customer_name" value=""
                                            required>
                                    </div>
                                    <div class="col-md-6"><label class="labels">Mobile Number</label><input type="text"
                                            class="form-control" placeholder="enter phone number"
                                            name="customer_contact" value="" readonly minlength="10" pattern="^(\+91[\-\s]?)?[0]?(91)?[6789]\d{9}$" inputmode="numeric"
                                            oninput="this.value = this.value.replace(/[^0-9]/g, '')" maxlength="10"></div>
                                    <div class="col-md-6"><label class="labels">Pincode</label><input type="text"
                                            class="form-control" placeholder="enter pincode" name="customer_pincode"
                                            inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                            maxlength="6" required></div>
                                    <div class="col-md-6"><label class="labels">Email ID</label><input type="email"
                                            class="form-control" placeholder="enter email id" name="customer_email"
                                            value="" required></div>
                                    <div class="col-md-6"><label class="labels">City</label><input type="text"
                                            class="form-control" placeholder="city" name="customer_city" value=""></div>
                                    <div class="col-md-6"><label class="labels">State/Region</label> <select
                                            id="customer_state" name="customer_state" style="width: 100%;"
                                            class=" form-control" tabindex="3" required>
                                            <option value="" disabled selected>Select your State</option>
                                            <option value="">-- Select State --</option>
                                            <option value="maharashtra">Maharashtra</option>
                                        </select></div>
                                </div>
                                <div class="mt-5 text-center"><button class="btn btn-primary profile-button"
                                        type="submit">Update
                                    </button>

                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        </div>
        <script>


            const userform = document.getElementById("user-form");
            const user_profile_container = document.querySelector(".container");
            const user_form_container = document.querySelector(".user-form-container");
            userform.addEventListener("submit", (e) => {
                e.preventDefault();

                const formData = new FormData(userform);
                const jsonData = {};

                for (let [key, value] of formData.entries()) {
                    jsonData[key] = value;
                }

                const storedContactId = localStorage.getItem("contactid");
                const formContactId = jsonData["customer_contact"];
                const formcustomer_name = jsonData["customer_name"];

                // Check if the stored contact ID matches the new one
                if (storedContactId !== formContactId) {
                    localStorage.setItem("contactid", formContactId);
                } else {
                }

                fetch("<%= url_pathname %>add-profile", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(jsonData),
                })
                    .then((res) => res.json())
                    .then((data) => {
                        if (data.success) {
                            localStorage.setItem("name", formcustomer_name)
                            showPopup("Success", data.message, "Success");
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        }
                    })
                    .catch((err) => {
                        showPopup("Error", "Some issue occurred", "Failure");
                        console.error("Error occurred:", err.message);
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    });
            });

            const contactId = localStorage.getItem("contactid");
            if (contactId) {

                const phone = String(localStorage.getItem("contactid"));
                const customer_name = document.querySelector("[name='customer_name']");
                const customer_email = document.querySelector("[name='customer_email']")
                const customer_contact = document.querySelector("[name='customer_contact']")
                const customer_address = document.querySelector("[name='customer_address']")
                const customer_pincode = document.querySelector("[name='customer_pincode']")
                const customer_city = document.querySelector("[name='customer_city']");
                const customer_state = document.querySelector("[name='customer_state']")
                fetch("<%=url_pathname %>user_contact_form", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ phone }),
                })
                    .then((res) => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then((data) => {
                        if (data?.data) {
                            localStorage.setItem("name",data.data.customer_name)
                            const user_name = document.querySelector(".user_name").innerText = data.data.customer_name;
                            const user_email = document.querySelector(".user_email").innerText = data.data.customer_email;
                            const user_contact = document.querySelector(".user_contact").innerText = data.data.customer_contact;
                            customer_name.value = data.data.customer_name || "";
                            customer_email.value = data.data.customer_email || "";
                            customer_contact.value = phone || "";
                            customer_address.value = data.data.customer_address || "";
                            customer_pincode.value = data.data.customer_pincode || "";
                            customer_city.value = data.data.customer_city || "";
                            customer_state.value = data.data.customer_state || "";
                            user_form_container.style.display = "none";
                            user_profile_container.style.display = "block"
                        } else {
                            const user_contact = document.querySelector(".user_contact").innerText = phone;
                            customer_contact.value = phone || "";
                            console.log("Errr")
                        }
                    })
                    .catch((e) => {
                        console.error("Error occurred:", e.message);
                    });
            }

            const logout = () => {
                localStorage.removeItem("contact");
                localStorage.removeItem("contactid");
                localStorage.removeItem("name");
                window.location.href = "/";
            }

            const updateProfile = () => {
                user_form_container.style.display = "block";
                user_profile_container.style.display = "none"
            }
        </script>
        <%- include("./addToCart.ejs") %>
</body>

</html>